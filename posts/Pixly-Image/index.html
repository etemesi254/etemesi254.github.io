<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"> </script><title>The architecture of Pixly - A simple image editor in Kotlin + Rust | shaded</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="shaded"><meta name="application-name" content="shaded"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">shaded</a></div><div class="site-subtitle font-italic">I will die up on that hill</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/etemesi254" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sacret_sauce" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['etemesicaleb','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>The architecture of Pixly - A simple image editor in Kotlin + Rust</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>The architecture of Pixly - A simple image editor in Kotlin + Rust</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1705302000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 15, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/sacret_sauce">Caleb</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2442 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/imgs/pixly/main_screen.png" alt="Main Window" data-proofer-ignore></p><p>Photo of tree by <a href="https://unsplash.com/@colinwatts?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Colin Watts</a> on <a href="https://unsplash.com/photos/a-dead-tree-in-the-middle-of-a-desert-RO5ZTQQmePc?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a></p><p>Pixly is an image editor for Android and Desktop platforms that uses Compose and Rust to achieve a simple image editing experience.</p><p>It provides a GUI/Frontend to my other toy project <a href="https://github.com/etemesi254/zune-image">zune-image</a>, a high perfomance library for decoding processing and encoding various image formats.</p><p>It has the features you’d expect from a simple editor, like history, image filters, thumbnails, image operations, e.t.c and some nice to haves like double pane layout and directory navigator.</p><p>Feature wise, it is definitely not there, but it has some nice properties I thought would be nice putting down somewhere, and this blog does exactly that, going into a high level overview of the architecture and the low level bits like getting pixels to screen and keeping memory usage low.</p><h2 id="why"><span class="mr-2">Why</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I wanted a small Lightroom alternative that works in Linux, that’s all.</p><h2 id="high-level-architecture"><span class="mr-2">High level architecture</span><a href="#high-level-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="application-logic"><span class="mr-2">Application logic</span><a href="#application-logic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Application logic is stored in <code class="language-plaintext highlighter-rouge">commonMain</code> which means it’s shared between the Desktop and Android endpoints.</p><p>Most logic is stored in <code class="language-plaintext highlighter-rouge">AppContext</code>, with functions manipulating what they need and widgets reacting to it.</p><p>Since there is no full one-to-one mapping of widgets and functionality between Android and Desktop, some functions/classes are represented as interfaces with each platform creating a concrete class that implements that interface.</p><p>The most common interfaces implemented include <a href="https://github.com/etemesi254/Pixly/blob/main/composeApp/src/commonMain/kotlin/ProtectedBitmapInterface.kt"><code class="language-plaintext highlighter-rouge">ProtectedBitmapInterface</code></a> which is just a platform specific image bitmap and a mutex that protects it from dangerous multithreaded accesses that may cause invalidations and segfaults and <a href="https://github.com/etemesi254/Pixly/blob/main/composeApp/src/commonMain/kotlin/ZilBitmapInterface.kt"><code class="language-plaintext highlighter-rouge">ZilBitmapInterface</code></a> that unifies the image operations that are implemented.</p><p>Most of the app logic lies in <a href="https://github.com/etemesi254/Pixly/blob/main/composeApp/src/commonMain/kotlin/AppContext.kt">AppContext.kt</a></p><h3 id="image-manipulation"><span class="mr-2">Image manipulation</span><a href="#image-manipulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>While Kotlin/Java is platform agnostic, Rust doesn’t have that as it is a compiled language, this means that <code class="language-plaintext highlighter-rouge">zune-image</code> has to be built for multiple endpoints/backends, the backends currently supported are <code class="language-plaintext highlighter-rouge">linux-x86-64</code>, <code class="language-plaintext highlighter-rouge">windows-x86-64-gnu</code> for desktop platforms and <code class="language-plaintext highlighter-rouge">aarch64-linux-android</code>,<code class="language-plaintext highlighter-rouge">armv7-linux-androideabi</code> and<code class="language-plaintext highlighter-rouge">i686-linux-android</code> for android platforms.</p><p>The overall image architecture looks like the following</p><p><img data-src="/assets/imgs/pixly/overall_architecture.png" alt="Overall architecture" data-proofer-ignore></p><p>The reason to have different platform specific interface implementors is because we have to do some ‘low-level’ manipulation in both Desktop and Android, to get pixels to the screen. Compose when targeting Android uses the Android’s default <a href="https://developer.android.com/reference/android/graphics/Bitmap">Bitmap</a> class for handling images while the desktop implements it’s own <a href="https://jetbrains.github.io/skiko/skiko/org.jetbrains.skia/-bitmap/index.html?query=class%20Bitmap%20:%20Managed,%20IHasImageInfo">SkiaBackedImageBitmap</a> each with a different API but all of can be converted to an <code class="language-plaintext highlighter-rouge">ImageBitmap</code> interface which encapsulates both classes to a single API surface.</p><p>Both of these have separate apis, e.g the desktop implementation can read from <code class="language-plaintext highlighter-rouge">ByteArray</code> via <a href="https://jetbrains.github.io/skiko/skiko/org.jetbrains.skia/-bitmap/index.html?query=class%20Bitmap%20:%20Managed,%20IHasImageInfo#-58173881%2FFunctions%2F788909594">Bitmap.installPixels</a> whereas the Android can read from <code class="language-plaintext highlighter-rouge">ByteBuffer</code> via <a href="https://developer.android.com/reference/android/graphics/Bitmap#copyPixelsFromBuffer(java.nio.Buffer)">Bitmap.copyPixelsFromBuffer</a></p><h3 id="widgets"><span class="mr-2">Widgets</span><a href="#widgets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As the project aimed to be multiplatform, this meant that there was a limit as to what can be considered platform agnostic, a simple thing such as how Android and Desktop compose handle svg/xml means that any path that was setting up such needed to be re-implemented in both platforms and non-trivial things such as color representation meant the image bits had to be repeated for both platforms.</p><p>If a widget or method qualified as platform agnostic(by qualification we mean it didn’t cause compile errors when compiled for both Android and Desktop),it was stored in <code class="language-plaintext highlighter-rouge">commonMain</code> , if not, it was placed in specific platform folder.</p><h2 id="getting-into-the-bits"><span class="mr-2">Getting into the bits</span><a href="#getting-into-the-bits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the high overview architecture explained, we can spend some more time looking into the low level details that actually make an image operation succeed and the nuances needed to make it work.</p><h3 id="jni"><span class="mr-2">JNI</span><a href="#jni" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Java communicates with other C like languages via the JNI, a <a href="https://en.wikipedia.org/wiki/Foreign_function_interface">Foreign Function Interface (FFI)</a> the JVM understands.</p><p>This means for us to implement the bridge between the JVM and Rust, we must write a small shill layer to handle that <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p><p>A sample code for Kotlin for jni looks like</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>
<span class="kd">class</span> <span class="nc">ZilImageJni</span>  <span class="p">{</span>
    <span class="c1">/// Image pointer, points to the memory that contains the Rust image struct</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">imagePtr</span><span class="p">:</span><span class="nc">Long</span> <span class="p">=</span> <span class="nf">createImagePtrNative</span><span class="p">()</span>
    
    <span class="c1">/// Create and load an image pointed to by `file`</span>
    <span class="k">constructor</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">loadImageNative</span><span class="p">(</span><span class="n">imagePtr</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">external</span> <span class="k">fun</span> <span class="nf">createImagePtrNative</span><span class="p">():</span> <span class="nc">Long</span>

    <span class="c1">// ... other methods</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The file that contains the JNI from kotlin side is found in <a href="https://github.com/etemesi254/Pixly/blob/main/composeApp/src/commonMain/kotlin/ZilImageJni.kt">commonMain/ZilImageJni.kt</a></p><p>A sample Rust code looks like</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cd">/// Create an image and return the pointer to that image in memory</span>
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"system"</span> <span class="k">fn</span> <span class="nf">Java_ZilImageJni_createImagePtrNative</span><span class="p">(</span><span class="n">_env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">_class</span><span class="p">:</span> <span class="n">JClass</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">jlong</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">image</span> <span class="o">=</span> <span class="nn">Image</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[],</span> <span class="nn">BitDepth</span><span class="p">::</span><span class="n">Unknown</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nn">ColorSpace</span><span class="p">::</span><span class="n">Unknown</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
    <span class="c1">// convert it to a pointer</span>
    <span class="nn">Box</span><span class="p">::</span><span class="nf">into_raw</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">as</span> <span class="n">jlong</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The name and order of arguments matter, as it should follow <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/jni/design.html">JNI specifications</a>. If JVM doesn’t find a method expected, the application crashes with an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/UnsatisfiedLinkError.html"><code class="language-plaintext highlighter-rouge">UnsatisfiedLinkError</code></a></p><p>The rust file containing JNI functions can be found in <a href="https://github.com/etemesi254/Pixly/blob/main/rust/src/lib.rs">rust/src/lib.rs</a></p><h3 id="initial-preprocessing"><span class="mr-2">Initial preprocessing</span><a href="#initial-preprocessing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Images come in different types, if we are to consider bit-depth and colorspace but the one thing we want to unify is how they are shown. Compose and Android use 32 bit ARGB where each image pixel is represented as a packed 32 bit integer, i.e <code class="language-plaintext highlighter-rouge">R</code> occupies 8 bits, <code class="language-plaintext highlighter-rouge">G</code> 8 bits and so do <code class="language-plaintext highlighter-rouge">B</code> and <code class="language-plaintext highlighter-rouge">A</code> they are then bit packed into one integer and that is represents a color.</p><p>So this means <code class="language-plaintext highlighter-rouge">zune-image</code> must obey the same layout, so on image loading, we convert the pixels to BGRA/RGBA depending on platform(we’ll explain this later) and then convert depth to 8 bits per image color.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ZilBitmap</span><span class="p">(</span><span class="k">inner</span><span class="p">:</span> <span class="nc">ZilImageInterface</span><span class="p">){</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">prepareNewFile</span><span class="p">(</span><span class="n">bitmap</span><span class="p">:</span> <span class="nc">ProtectedBitmapInterface</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// convert depth to u8</span>
        <span class="k">inner</span><span class="p">.</span><span class="nf">convertDepth</span><span class="p">(</span><span class="nc">ZilDepth</span><span class="p">.</span><span class="nc">U8</span><span class="p">);</span>
        <span class="c1">// convert colorspace to BGRA</span>
        <span class="k">inner</span><span class="p">.</span><span class="nf">convertColorspace</span><span class="p">(</span><span class="nc">ZilColorspace</span><span class="p">.</span><span class="nc">BGRA</span><span class="p">)</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="getting-memory-from-rust-to-the-screen"><span class="mr-2">Getting Memory from Rust to the screen.</span><a href="#getting-memory-from-rust-to-the-screen" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">zune-image</code> does most of the heavy lifting when it comes to processing, so when you press any slider, it needs to manipulate pixels and send those pixels back to kotlin for them to be rendered by skia.</p><p><code class="language-plaintext highlighter-rouge">zune-image</code> represents images in planar format but Compose/Skia wants data in interleaved <code class="language-plaintext highlighter-rouge">ARGB</code>, so we have to convert planar channels into ARGB before we send to skia. <img data-src="/assets/imgs/pixly/zune_image_to_kotlin.gif" alt="Animation of Planar to RGB" data-proofer-ignore></p><p>An interesting thing is that skia uses ARGB in little endian, with 32 bit number to represent a pixel, when processing images, we represent each pixel with a byte (assuming a bit depth of 8), so that means in memory were we to pack ARGB into an integer, we would have the most significant bit as <code class="language-plaintext highlighter-rouge">A</code> and the least significant bit as <code class="language-plaintext highlighter-rouge">B</code>.</p><p>But such normal packing is what is expected in big-endian architectures, little endian has the least significant bit in the left and most significant in the right, it would appear backwards when visualized, meaning were we to actually convert to ARGB, we would be showing wrong color mixes.</p><p>Well the solution is to convert it to <code class="language-plaintext highlighter-rouge">BGRA</code>, we mentioned little endian looks backwards when visualized, and if we are to arrange <code class="language-plaintext highlighter-rouge">ARGB</code> backwards, we would have <code class="language-plaintext highlighter-rouge">BGRA</code>, so this is the colorspace that shows the right colors on the screen.</p><h3 id="keeping-memory-usage-low"><span class="mr-2">Keeping memory usage low</span><a href="#keeping-memory-usage-low" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><img data-src="/assets/imgs/pixly/memory_usage.png" alt="A 5184 by 3456 image opened in pixly, there is a yellow hightlight" data-proofer-ignore></p><p>Images can get very big very quickly, the above picture shows a 5184 x 3456 image using 68 Mb for it’s in memory pixel cache (highlighted in yellow box) whereas the size in disk is just 2.3 mb( highlighted in purple box)</p><p>It gets more complicated</p><ul><li><code class="language-plaintext highlighter-rouge">zune-image</code> needs to store it’s own copy of pixels<li>skia also stores pixels in its own native memory<li>We need a way to transfer bytes from zune-image to skia, which means we need a big enough buffer to hold all image pixels.<li>Jvm doesn’t allow one to acess <code class="language-plaintext highlighter-rouge">ByteArray</code> from native code, only directly allocated buffers using <code class="language-plaintext highlighter-rouge">ByteBuffer</code> can be accessed in native meethods so we need a <code class="language-plaintext highlighter-rouge">ByteBuffer</code> that can hold image pixels</ul><p>Each one of the above is an allocation as big enough as the image loaded, which means we need 4x the image storage to show it to screen.</p><p>Furthermore, adding history rollbacks, especially on operations where we have to create a copy(e.g when implementing undo for a blur opetation), we may end up consuming a lot of memory if we aren’t careful.</p><p>While there are some allocations we can’t prevent, we can ensure those we control don’t devolve into anarchy by reusing allocations where possible.</p><h4 id="saving-on-bytebuffer-memory"><span class="mr-2">Saving on bytebuffer memory</span><a href="#saving-on-bytebuffer-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>One place we can optimize is the buffers used for writing pixels from Rust JNI to something the Jvm understands, a naive solution would be to create a bufer and write to it on every invocation that needs to see pixels, this would go very bad very quickly, as it would create short lived but very big arrays putting pressure on the operating system and the JVM when it has to do garbage collection.</p><p>To solve this, we can create one big array and share it with various operations that manipulate the image in any way but ensuring we protect it via a mutex to prevent data races and pointer invalidations.</p><p>The name aptly given to this is the <a href="https://github.com/etemesi254/Pixly/blob/6012fdafc5d2b9a7c76934ac6d7559c804ab07d1/composeApp/src/commonMain/kotlin/AppContext.kt#L25"><code class="language-plaintext highlighter-rouge">SharedBufer</code></a> which literally represents a shared buffer used by various image operations.</p><p>An operation can lock the <code class="language-plaintext highlighter-rouge">SharedBuffer</code>’s mutex and then it’s free to allocate, resize,deallocate or replace the buffers present. This helps us only have one buffer even when multiple images are opened or after multiple operations have been executed, saving us memory.</p><h4 id="reusing-bitmap-allocations-when-possible"><span class="mr-2">Reusing Bitmap allocations when possible</span><a href="#reusing-bitmap-allocations-when-possible" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Another area we can optimize is by carefully considering how skia image works which processes allocate and using that knowledge to reduce allocations as much as possible.</p><p>On desktop, skia image contains <code class="language-plaintext highlighter-rouge">allocPixels</code> that allocates pixel memory, we can optimize the function that calls this to only change if the storage doesn’t match i.e the function that does that in desktop is</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ZilBitmap</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">allocBuffer</span><span class="p">(</span><span class="n">bitmap</span><span class="p">:</span> <span class="nc">Bitmap</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// check if buffer would fit the new type</span>
        <span class="c1">// i.e do not pre-allocate</span>
        <span class="kd">val</span> <span class="py">infoSize</span> <span class="p">=</span> <span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="p">*</span> <span class="n">image</span><span class="p">.</span><span class="n">width</span>
        <span class="kd">val</span> <span class="py">imageSize</span> <span class="p">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">height</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span> <span class="p">*</span> <span class="n">image</span><span class="p">.</span><span class="nf">width</span><span class="p">().</span><span class="nf">toInt</span><span class="p">();</span>

        <span class="n">info</span> <span class="p">=</span> <span class="nc">ImageInfo</span><span class="p">.</span><span class="nf">makeN32</span><span class="p">(</span>
                <span class="n">image</span><span class="p">.</span><span class="nf">width</span><span class="p">().</span><span class="nf">toInt</span><span class="p">(),</span>
                <span class="n">image</span><span class="p">.</span><span class="nf">height</span><span class="p">().</span><span class="nf">toInt</span><span class="p">(),</span>
                <span class="nc">ColorAlphaType</span><span class="p">.</span><span class="nc">UNPREMUL</span><span class="p">,</span>
                <span class="nc">ColorSpace</span><span class="p">.</span><span class="n">sRGB</span><span class="p">)</span>

        <span class="n">bitmap</span><span class="p">.</span><span class="nf">setImageInfo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">infoSize</span> <span class="p">!=</span> <span class="n">imageSize</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">assert</span><span class="p">(</span><span class="n">bitmap</span><span class="p">.</span><span class="nf">allocPixels</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This function does something interesting, it modifies image information per invocation, but only allocates the pixel if info size varies from the new image size. This makes sense when considering operations like <code class="language-plaintext highlighter-rouge">brighten</code> don’t modify pixel size but also means operations like <code class="language-plaintext highlighter-rouge">rotate</code> and <code class="language-plaintext highlighter-rouge">transpose</code> which just change dimensions won’t cause a reallocation,we only re-allocate when we have to.</p><h3 id="hinting-the-gc-that-it-should-probalby-run"><span class="mr-2">Hinting the GC that it should probalby run</span><a href="#hinting-the-gc-that-it-should-probalby-run" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The Java garbage collector takes care of memory for the programmer and runs occasionaly to free resources with no references.</p><p>Image programs use a lot of data when dealing with history, for there are operations we need to store a whole copy of the image, but sometimes these are short lived.</p><p>An example is if you change the slider for contrast and then undo it, for those chain of operations, we have to create a copy of the image, apply contrast operation, render to screen, and then remove the copy of the image from our history, this means that the memory the image used should be freed, but when this occurs is non-deterministic.</p><p>But we know where we expect memory pressure, when we add an element to history, and when we remove an element from it, so on such places, we can simply hint the Garbage collector telling it to free memory.</p><p>Java provides <code class="language-plaintext highlighter-rouge">System.gc()</code> which is a hint to the JVM to carry out grabage collection, and we insert this into the functions that deal with history.</p><p>Here, we trade CPU cycles to get a better memory usage, how beneficial that is, it’s up for debate</p><h2 id="threads-mutexes-and-preventing-segfaults"><span class="mr-2">Threads, mutexes and preventing segfaults</span><a href="#threads-mutexes-and-preventing-segfaults" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When an image operation like <code class="language-plaintext highlighter-rouge">blur</code> or <code class="language-plaintext highlighter-rouge">exposure</code> is requested, the operation is launched on an IO thread to prevent blocking of the UI thread.</p><p>Kotlin has powerful coroutines, which depending on configuration, dispatch requests to the main UI thread, blocking any other work or what it calls IO threads which is a threadpool maintained by the Jvm where calls using <code class="language-plaintext highlighter-rouge">Dispatchers.IO</code> are ran on.</p><p>While it is obvious that we would have image operations running on I/O thread, we reach a dangerous path when we mix it with the memory optimizations mentioned above.</p><p>Specifically assume we are running a CPU intensive operation like <code class="language-plaintext highlighter-rouge">median blur</code>, while it’s running, the user also increases contrast, the <code class="language-plaintext highlighter-rouge">contrast</code> runs on a separate thread and finishes before the initial <code class="language-plaintext highlighter-rouge">median blur</code>, then it updates the canvas and then finally <code class="language-plaintext highlighter-rouge">median blur</code> finishes and updates the canvas.What will happen is that the canvas will contain <code class="language-plaintext highlighter-rouge">median blur</code> changes but not <code class="language-plaintext highlighter-rouge">contrast</code> changes, that introduces an inconsitency in operations.</p><p>But such is a mere annoyance, the real problem comes when we think about bitmaps, specifically we only use one bitmap to keep memory low, the address of the pixel location of the bitmap isn’t static and may be invalidated e.g when we change an image, so the problem may be that the UI thread is drawing just finished pixels and it’s still in the step of reading them from memory and a new operation invalidates that memory address leaving it with a dangling pointer,or what <code class="language-plaintext highlighter-rouge">C</code> people call use-after-free.</p><p>If you are lucky, skia will complain with <code class="language-plaintext highlighter-rouge">FailedToMakeBitmap</code> <code class="language-plaintext highlighter-rouge">ptr=null</code> and if you spent enough time in low level languages like <code class="language-plaintext highlighter-rouge">C/C++</code>, you’d understand skia found a null pointer, if you aren’t the application just segfaults, and you get a nice memory and thread dump to tell you you really messed up.</p><p>The fix for such things is to introduce mutexes, mutexes help protect shared resources you don’t want people peeking into and grabbing it from you, this is the reason for the existence of <code class="language-plaintext highlighter-rouge">ProtectedBitmapInterface</code>, it is a bitmap that is protected by a mutex, the interface is very simple</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">ProtectedBitmapInterface</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">asImageBitmap</span><span class="p">():</span> <span class="nc">ImageBitmap</span>

    <span class="k">fun</span> <span class="nf">mutex</span><span class="p">():</span> <span class="nc">Mutex</span>

<span class="p">}</span>
</pre></table></code></div></div><p>The usage is that you are to lock the mutex returned by the <code class="language-plaintext highlighter-rouge">mutex</code> before you read the image via the <code class="language-plaintext highlighter-rouge">asImageBitmap</code> , this helps us ensure that there is always one reader or writer of this class at a time, and if correctly used, no two threads should manipulate the same resource at the same time.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The challenge was a fun one, with a lot learnt in how to mkake two systems communicate with each other correctly, the app is definitely not production ready yet, a lot of bugs still exist and the latency between the image operations to the screen make for a noticeable lag not experienced in other professional image editors like Lightroom.</p><hr /><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>That may change soon, see <a href="https://openjdk.org/projects/panama/">Project Panama</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/architecture/'>architecture</a>, <a href='/categories/kotlin/'>kotlin</a>, <a href='/categories/multiplatform/'>multiplatform</a>, <a href='/categories/rust/'>rust</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >kotlin</a> <a href="/tags/architecture/" class="post-tag no-text-decoration" >architecture</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=The+architecture+of+Pixly+-+A+simple+image+editor+in+Kotlin+%2B+Rust+-+shaded&url=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FPixly-Image%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=The+architecture+of+Pixly+-+A+simple+image+editor+in+Kotlin+%2B+Rust+-+shaded&u=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FPixly-Image%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FPixly-Image%2F&text=The+architecture+of+Pixly+-+A+simple+image+editor+in+Kotlin+%2B+Rust+-+shaded" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Zune-Benchmarks/">Zune benchmarks</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/compression-lz77-huffman-tans/">compression,lz77,huffman,tANS</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Zune-Benchmarks/"><div class="card-body"> <em class="small" data-ts="1667113200" data-df="ll" > Oct 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Zune benchmarks</h3><div class="text-muted small"><p> This contains a permalink to the zune library benchmarks, reports provided by criterion Currently, benchmarks are ran on my machine, but will hopefully soon move to a cloud provider Machine Specs...</p></div></div></a></div><div class="card"> <a href="/posts/Transposing-Matrices/"><div class="card-body"> <em class="small" data-ts="1667113200" data-df="ll" > Oct 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Transposing matrices, The Fast way.</h3><div class="text-muted small"><p> Matrix transposition is one of the most common things computers do as this operation creeps itself into many day-to-day computer operations From optimized 1D convolution kernels that make gaussi...</p></div></div></a></div><div class="card"> <a href="/posts/Google-Summer-Of-Code-Writeup/"><div class="card-body"> <em class="small" data-ts="1662706800" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Google Summer of Code Writeup - Adding HTJ2K to FFmpeg</h3><div class="text-muted small"><p> The patch that was submitted to ffmpeg can be viewed here A working ffmpeg implementation used to produce image samples can be found here The recently concluded Google Summer of Code prog...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Zune-Benchmarks/" class="btn btn-outline-primary" prompt="Older"><p>Zune benchmarks</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sacret_sauce">Caleb</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/compression-lz77-huffman-tans/">compression,lz77,huffman,tANS</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
