<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"> </script><title>Transposing matrices, The Fast way. | shaded</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="shaded"><meta name="application-name" content="shaded"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">shaded</a></div><div class="site-subtitle font-italic">I will die up on that hill</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/etemesi254" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sacret_sauce" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['etemesicaleb','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Transposing matrices, The Fast way.</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Transposing matrices, The Fast way.</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1667113200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 30, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/sacret_sauce">Caleb</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1268 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/imgs/matrix_transposition/SimpleMatrixTransposition_ManimCE_v0.16.0.post0.gif" alt="Matrix Transposition" data-proofer-ignore></p><p>Matrix transposition is one of the most common things computers do as this operation creeps itself into many day-to-day computer operations</p><p>From optimized 1D convolution kernels that make gaussian blurs possible to optimized matrix multiply algorithms that are the heart of many machine learning operations, it is safe to say this operation <a href="https://www3.nd.edu/~shu/research/papers/ipdps01.pdf">has</a> <a href="http://www.cs.technion.ac.il/~itai/Courses/Cache/matrix-transposition.pdf">received</a> <a href="https://arxiv.org/pdf/2001.04109.pdf">adequate</a> <a href="https://hal.inria.fr/hal-02960539/document">research</a></p><h2 id="the-naive-way-to-transpose-a-matrix"><span class="mr-2">The naive way to transpose a matrix</span><a href="#the-naive-way-to-transpose-a-matrix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Using the earlier representation of a matrix, matrix transposition is a simple data access and data write for every element in the array</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">transpose_scalar</span><span class="p">(</span><span class="n">in_matrix</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span>
        <span class="n">out_matrix</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">u8</span><span class="p">],</span>
        <span class="n">in_stride</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
        <span class="n">out_stride</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">out_stride</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">in_stride</span>
        <span class="p">{</span>
            <span class="n">out_matrix</span><span class="p">[(</span><span class="n">j</span> <span class="o">*</span> <span class="n">out_stride</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_matrix</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This is simple, ergonomic, works, does nothing fancy and gets the job done and it’s slow.</p><p>The latter is what comes to pinch us here.</p><p>From a CPU standpoint, array accesses to <code class="language-plaintext highlighter-rouge">in_matrix</code> happen linearly, i.e we move from start to end, which is great, and the cpu can prefetch elements, but accesses to <code class="language-plaintext highlighter-rouge">out_matrix</code> happen very stride-wise, assuming <code class="language-plaintext highlighter-rouge">out_stride</code> was 800, accesses to <code class="language-plaintext highlighter-rouge">B</code> for 5 iterations would be</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0 800 1600 2400 3200 4000
</pre></table></code></div></div><p>This makes it a bit harder for prefetch logic to kick in, and even when it does, it causes a lot of cache wastage as we are loading a whole cache line to write one value.</p><h2 id="tiled-matrix-transpose"><span class="mr-2">Tiled matrix transpose</span><a href="#tiled-matrix-transpose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Another way to look at matrix transposition is that a matrix transposition can be viewed as a submatrix transposing followed by figuring out where the newly transposed submatrix should go to.</p><p><img data-src="/assets/imgs/matrix_transposition/LargerMatrixTransposition_ManimCE_v0.16.0.post0.png" alt="Matrix Transposition" data-proofer-ignore></p><p>E.g in the above image, we can transpose the three-by-three matrix (coloured in red) and if we place it at the position coloured yellow, we have achieved transposition.</p><p>Or more generically, we are trying to achieve…</p><p><img data-src="/assets/imgs/matrix_transposition/TiledMatrix.png" alt="Tiled Transpose" data-proofer-ignore></p><p>But why transpose sub-matrices? Well,the most important is that cache misses reduce <em>significantly</em> for the operation. The sub-matrices have good spatial locality, hence we use the cache better.</p><p>But there is another thing with sub-matrices, sub-matrix transposes can be done in SIMD registers.</p><p>If we use a small enough sub-matrix, we can get rid of intermediate buffers to store the results of the matrix transposition and use SIMD instructions to perfom matrix transposition inside SIMD registers.</p><p>Intel has a famous <a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=_MM_TRANSPOSE4_PS&amp;ig_expand=7273"><code class="language-plaintext highlighter-rouge">_MM_TRANSPOSE4_PS</code></a> that can transpose floats in four SIMD registers so if we choose a 4 by 4 sub-matrix of floats, we can do some <a href="https://stackoverflow.com/a/16743203">tilling to get it to work</a> (with some caveats of course <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>)</p><p>For my use case, I happened to be working with u8’s/bytes/chars hence I didn’t have the luxury of enjoying macros.</p><p>The only difference arising is that I just need to roll up my routine, which does a submatrix transpose of any size that comfortably fits into a SIMD register, and am 8 by 8 transpose seemed to hit the spot.</p><p>There is a small awkward issue with this, that being the fact SSE register is 128 bits while 8 u8’s give me a total of 64 bits, meaning that data loading and storing are a bit awkward but otherwise everything is good.</p><p>The 8 by 8 SSE transposition algorithm is not my own, credits to Hamid Buzidi(<a href="https://twitter.com/powturbo">powturbo</a>) for the <a href="https://stackoverflow.com/a/42316675">Stack Overflow</a> answer.</p><p>So a high overview of the implementation we are trying to implement is.</p><ol><li>Load a submatrix<li>Transpose the submatrix<li>Write the submatrix.</ol><p>So let’s get on with it</p><ul><li><p>Loading data</p><p>SSE registers usually fit 16 bytes in them, but for our use case we are working with a 8 by 8 sub-matrix.</p><p>To load data into it, we use <code class="language-plaintext highlighter-rouge">_mm_loadl_epi64</code> to only load 8 bytes into the lower half and then we interleave the two subsequent loads into one register using <code class="language-plaintext highlighter-rouge">_mm_unpacklo_epi64</code> instruction. This allows us to pack two rows separated by a stride into a single <code class="language-plaintext highlighter-rouge">xmm</code> register.</p><p>The effect is that we have two rows of our sub-matrix inside one SSE register,hence we just need 4 registers to hold our 8 by 8 sub-matrix</p></ul><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">transpose_inner</span><span class="p">(</span>
    <span class="n">in_matrix</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span> <span class="n">out</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">u8</span><span class="p">],</span>
    <span class="n">in_stride</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">out_stride</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Load data from memory</span>
    <span class="c1">// Load 64 bites to ensure we only take 8 u8's</span>
    <span class="k">let</span> <span class="n">mn_0</span> <span class="o">=</span> <span class="nf">_mm_loadl_epi64</span><span class="p">(</span><span class="n">in_matrix</span><span class="p">[</span><span class="n">pos</span><span class="o">..</span><span class="p">]</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast</span><span class="p">());</span>
    <span class="n">pos</span> <span class="o">+=</span> <span class="n">in_stride</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">mn_1</span> <span class="o">=</span> <span class="nf">_mm_loadl_epi64</span><span class="p">(</span><span class="n">in_matrix</span><span class="p">[</span><span class="n">pos</span><span class="o">..</span><span class="p">]</span><span class="nf">.as_ptr</span><span class="p">()</span><span class="nf">.cast</span><span class="p">());</span>
    <span class="n">pos</span> <span class="o">+=</span> <span class="n">in_stride</span><span class="p">;</span>
    <span class="c1">// pack the first row with the second row</span>
    <span class="k">let</span> <span class="n">rw_01</span> <span class="o">=</span> <span class="nf">_mm_unpacklo_epi64</span><span class="p">(</span><span class="n">mn_0</span><span class="p">,</span> <span class="n">mn_1</span><span class="p">);</span>
    <span class="c1">// repeat this 3 more times</span>
</pre></table></code></div></div><ul><li>Transposing</ul><p>Use <code class="language-plaintext highlighter-rouge">pushfb</code> to perform a lookup that does some data moving for us.</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="n">sv</span> <span class="o">=</span> <span class="nf">_mm_set_epi8</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">//</span>
<span class="k">let</span> <span class="n">ov_0</span> <span class="o">=</span> <span class="nf">_mm_shuffle_epi8</span><span class="p">(</span><span class="n">rw_01</span><span class="p">,</span> <span class="n">sv</span><span class="p">);</span>
<span class="k">let</span> <span class="n">ov_1</span> <span class="o">=</span> <span class="nf">_mm_shuffle_epi8</span><span class="p">(</span><span class="n">rw_23</span><span class="p">,</span> <span class="n">sv</span><span class="p">);</span>
<span class="c1">// Two more times</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">pushfb</code> is a pretty nifty instruction we can use to do some data moving within a SIMD register. It’s usually hard to grasp but it has a nice magic to it.</p><p>To understand what the <code class="language-plaintext highlighter-rouge">shuffle</code> will do, think about it like this, if the source register <code class="language-plaintext highlighter-rouge">rw_0</code> was an array from 0-15, the shuffle instruction would move the data to be the same as itself, i.e <code class="language-plaintext highlighter-rouge">15</code>,<code class="language-plaintext highlighter-rouge">7</code>,<code class="language-plaintext highlighter-rouge">14</code> ,etc, etc in a single cycle, pretty neat.</p><p><img data-src="/assets/imgs/matrix_transposition/PushfbInstruction_ManimCE_v0.16.0.post0.png" alt="Pushfb instruction" data-proofer-ignore></p><p>We then unpack and interleave the data until we have two adjacent rows next to each other in the registers.</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// repeat this two  more times</span>
<span class="k">let</span> <span class="n">iv_0</span> <span class="o">=</span> <span class="nf">_mm_unpacklo_epi16</span><span class="p">(</span><span class="n">ov_0</span><span class="p">,</span> <span class="n">ov_1</span><span class="p">);</span>
<span class="k">let</span> <span class="n">iv_1</span> <span class="o">=</span> <span class="nf">_mm_unpackhi_epi16</span><span class="p">(</span><span class="n">ov_0</span><span class="p">,</span> <span class="n">ov_1</span><span class="p">);</span>
<span class="c1">// repeat this again two more times</span>
<span class="k">let</span> <span class="n">av_0</span> <span class="o">=</span> <span class="nf">_mm_unpacklo_epi32</span><span class="p">(</span><span class="n">iv_0</span><span class="p">,</span> <span class="n">iv_2</span><span class="p">);</span>
<span class="k">let</span> <span class="n">av_1</span> <span class="o">=</span> <span class="nf">_mm_unpackhi_epi32</span><span class="p">(</span><span class="n">iv_0</span><span class="p">,</span> <span class="n">iv_2</span><span class="p">);</span>
<span class="c1">//...</span>
</pre></table></code></div></div><ul><li>Storing</ul><p>To store the values, we write high and low values of the register to different destinations, separated by stride. extracting the high value into a lower value is done by a <code class="language-plaintext highlighter-rouge">_mm_unpackhi_epi64</code> instruction and we store with <code class="language-plaintext highlighter-rouge">_mm_storel_epi64</code> to only store the lower 64 bits of the <code class="language-plaintext highlighter-rouge">xmm</code> register.</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// Extract the higher part of the register since we will be writing it</span>
<span class="c1">// to a different stride, (one store should only add 8 bytes)</span>

<span class="k">let</span> <span class="n">sv_0</span> <span class="o">=</span> <span class="nf">_mm_unpackhi_epi64</span><span class="p">(</span><span class="n">av_0</span><span class="p">,</span> <span class="nf">_mm_setzero_si128</span><span class="p">());</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nf">_mm_storel_epi64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="o">..</span><span class="p">]</span><span class="nf">.as_mut_ptr</span><span class="p">()</span><span class="nf">.cast</span><span class="p">(),</span> <span class="n">av_0</span><span class="p">);</span>
<span class="n">pos</span> <span class="o">+=</span> <span class="n">out_stride</span><span class="p">;</span>
<span class="nf">_mm_storel_epi64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="o">..</span><span class="p">]</span><span class="nf">.as_mut_ptr</span><span class="p">()</span><span class="nf">.cast</span><span class="p">(),</span> <span class="n">sv_0</span><span class="p">);</span>
<span class="n">pos</span> <span class="o">+=</span> <span class="n">out_stride</span><span class="p">;</span>
<span class="c1">// Repeat this 6 more times.</span>
</pre></table></code></div></div><div style="display:flex;align-items:center"><div style="margin-bottom:4px;margin-right:30px"> <a href="https://godbolt.org/z/axoorxT8o" style="color:var(--text-color);border-bottom:none"><div style="display:flex;align-items: center"> <img class="icon-image" data-src="https://raw.githubusercontent.com/compiler-explorer/compiler-explorer/main/static/favicon.ico" data-proofer-ignore><div style="margin-left: 10px">Godbolt</div></div></a></div><a href="https://gist.github.com/etemesi254/c96ac114ca6c7cad24a188e753d38b99" style="color:var(--text-color);border-bottom:none"><div style="display:flex;align-items: center"> <i class="fab fa-github fa-lg"></i><div style="margin-left: 10px">Github Gist - Full implementation</div></div></a></div><p>And that’s it.</p><p>To recap,doing SIMD matrix transposition is:</p><ul><li>Load a sub-matrix into a SIMD register.<li>Perform in-place matrix transposition.<li>Write the data out to the appropriate destination</ul><h2 id="benchmarks"><span class="mr-2">Benchmarks</span><a href="#benchmarks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To see which one is faster, we can simply do a matrix transposition,utilizing Rust’s benchmark facilities (which require a nightly compiler)</p><p>The benchmark routine looks like this,</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// -- Sniped ---</span>
<span class="nd">#[bench]</span>
<span class="k">fn</span> <span class="nf">transpose_benchmark</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">test</span><span class="p">::</span><span class="n">Bencher</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">let</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">dimensions</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">in_vec</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">255</span><span class="p">;</span> <span class="n">dimensions</span><span class="p">];</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">out_vec</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">dimensions</span><span class="p">];</span>
    <span class="n">b</span><span class="nf">.iter</span><span class="p">(||</span> <span class="p">{</span>
        <span class="c1">// transpose scalar or vector</span>

    <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>It transposes an 800 by 800 matrix(medium size) array out of place and we time how many nanoseconds it takes to perform a single iteration.</p><p>And the results.</p><div class="table-wrapper"><table><thead><tr><th><strong>Test</strong><th><strong>ns/iter</strong><tbody><tr><td>transpose_scalar<td>496,739 ns/iter (+/- 38,252)<tr><td>transpose_sse<td>68,020 ns/iter (+/- 7,733)</table></div><p><em>Results are reproducible on x86 hardware</em></p><p>Yep, that’s a 7x improvement right there.</p><h2 id="further-reads"><span class="mr-2">Further Reads</span><a href="#further-reads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Nvidia’s blog on Tiled matrix transposition on the GPU: <a href="https://developer.nvidia.com/blog/efficient-matrix-transpose-cuda-cc/">https://developer.nvidia.com/blog/efficient-matrix-transpose-cuda-cc/</a></ul><h3 id="footer"><span class="mr-2">Footer</span><a href="#footer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>Only works for matrices whose widths and heights are multiples of 4 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/optimizations/'>optimizations</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/rust/" class="post-tag no-text-decoration" >rust</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Transposing+matrices%2C+The+Fast+way.+-+shaded&url=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FTransposing-Matrices%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Transposing+matrices%2C+The+Fast+way.+-+shaded&u=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FTransposing-Matrices%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fetemesi254.github.io%2F%2Fposts%2FTransposing-Matrices%2F&text=Transposing+matrices%2C+The+Fast+way.+-+shaded" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Zune-Benchmarks/">Zune benchmarks</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/compression-lz77-huffman-tans/">compression,lz77,huffman,tANS</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Zune-Benchmarks/"><div class="card-body"> <em class="small" data-ts="1667113200" data-df="ll" > Oct 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Zune benchmarks</h3><div class="text-muted small"><p> This contains a permalink to the zune library benchmarks, reports provided by criterion Currently, benchmarks are ran on my machine, but will hopefully soon move to a cloud provider Machine Specs...</p></div></div></a></div><div class="card"> <a href="/posts/Pixly-Image/"><div class="card-body"> <em class="small" data-ts="1705302000" data-df="ll" > Jan 15, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The architecture of Pixly - A simple image editor in Kotlin + Rust</h3><div class="text-muted small"><p> Photo of tree by Colin Watts on Unsplash Pixly is an image editor for Android and Desktop platforms that uses Compose and Rust to achieve a simple image editing experience. It provides a GUI/F...</p></div></div></a></div><div class="card"> <a href="/posts/Google-Summer-Of-Code-Writeup/"><div class="card-body"> <em class="small" data-ts="1662706800" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Google Summer of Code Writeup - Adding HTJ2K to FFmpeg</h3><div class="text-muted small"><p> The patch that was submitted to ffmpeg can be viewed here A working ffmpeg implementation used to produce image samples can be found here The recently concluded Google Summer of Code prog...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Google-Summer-Of-Code-Writeup/" class="btn btn-outline-primary" prompt="Older"><p>Google Summer of Code Writeup - Adding HTJ2K to FFmpeg</p></a> <a href="/posts/Zune-Benchmarks/" class="btn btn-outline-primary" prompt="Newer"><p>Zune benchmarks</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sacret_sauce">Caleb</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/compression-lz77-huffman-tans/">compression,lz77,huffman,tANS</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
